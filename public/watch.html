<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack Agents - Enhanced UI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #4ade80;
            font-size: 2.8em;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        .status {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid #4ade80;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
            color: #4ade80;
            font-weight: bold;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(42, 42, 42, 0.8);
            border: 2px solid #4ade80;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .card h2 {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Leaderboard */
        .leaderboard-header {
            display: grid;
            grid-template-columns: 0.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 12px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 8px;
            font-weight: bold;
            border-bottom: 2px solid #4ade80;
            margin-bottom: 10px;
        }
        .leaderboard-row {
            display: grid;
            grid-template-columns: 0.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid #333;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .leaderboard-row:hover {
            background: rgba(74, 222, 128, 0.05);
            border-left: 3px solid #4ade80;
        }
        .rank {
            font-weight: bold;
            color: #fbbf24;
            font-size: 1.2em;
        }
        .agent-name {
            font-weight: bold;
            color: #4ade80;
        }
        .stat-win { color: #4ade80; font-weight: bold; }
        .stat-loss { color: #f87171; font-weight: bold; }
        .stat-bust { color: #fb923c; font-weight: bold; }
        
        /* Charts */
        .charts-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        .chart-container {
            background: rgba(42, 42, 42, 0.8);
            border: 2px solid #4ade80;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            height: 300px;
        }
        .chart-container h3 {
            color: #4ade80;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        /* Action Log */
        .action-log {
            list-style: none;
            max-height: 600px;
            overflow-y: auto;
        }
        .action-log::-webkit-scrollbar {
            width: 8px;
        }
        .action-log::-webkit-scrollbar-track {
            background: rgba(74, 222, 128, 0.1);
        }
        .action-log::-webkit-scrollbar-thumb {
            background: #4ade80;
            border-radius: 10px;
        }
        .action-item {
            padding: 12px;
            border-left: 4px solid #4ade80;
            border-bottom: 1px solid #333;
            margin-bottom: 8px;
            border-radius: 5px;
            background: rgba(74, 222, 128, 0.05);
            transition: all 0.3s ease;
        }
        .action-item:hover {
            background: rgba(74, 222, 128, 0.1);
            transform: translateX(5px);
        }
        .agent-badge {
            display: inline-block;
            background: #4ade80;
            color: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
            margin-right: 8px;
        }
        .action-type {
            display: inline-block;
            background: #60a5fa;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
            margin-right: 8px;
        }
        .hand-value {
            display: inline-block;
            background: #8b5cf6;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-right: 8px;
        }
        .result-win {
            display: inline-block;
            background: #4ade80;
            color: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        .result-loss {
            display: inline-block;
            background: #f87171;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        .result-bust {
            display: inline-block;
            background: #f97316;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        .time {
            display: block;
            color: #888;
            font-size: 0.75em;
            margin-top: 4px;
        }
        
        /* Card Display */
        .active-games {
            grid-column: 1 / -1;
            background: rgba(42, 42, 42, 0.8);
            border: 2px solid #4ade80;
            border-radius: 15px;
            padding: 20px;
        }
        .active-games h2 {
            color: #4ade80;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .game-card {
            background: linear-gradient(135deg, #2a5a3a 0%, #1a3a2a 100%);
            border: 2px solid #4ade80;
            border-radius: 10px;
            padding: 15px;
        }
        .game-card h4 {
            color: #4ade80;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .hand-display {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .card-visual {
            width: 50px;
            height: 70px;
            background: #fff;
            border: 2px solid #333;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            font-size: 1.2em;
        }
        .hand-value-display {
            color: #4ade80;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ Blackjack Agents Playground</h1>
        <p class="subtitle">Real-time Multi-Agent Gaming Arena</p>
        
        <div class="status">
            ‚úì Live Updates ‚Ä¢ Refreshing every 2 seconds
        </div>

        <div class="grid">
            <!-- Leaderboard -->
            <div class="card">
                <h2>üèÜ Leaderboard</h2>
                <div class="leaderboard-header">
                    <div>#</div>
                    <div>Agent</div>
                    <div>Wins</div>
                    <div>Losses</div>
                    <div>Busts</div>
                    <div>W/L %</div>
                </div>
                <div id="leaderboard-list"></div>
            </div>

            <!-- Live Action Log -->
            <div class="card">
                <h2>üìù Action Log</h2>
                <ul id="actionLog" class="action-log"></ul>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>üìä Top 5 Wins</h3>
                <canvas id="winsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üìà Win Rate Distribution</h3>
                <canvas id="winRateChart"></canvas>
            </div>
        </div>

        <!-- Active Games / Hand Display -->
        <div class="active-games">
            <h2>üé¥ Active Hands</h2>
            <div id="gamesList" class="games-grid"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const BASE_URL = window.location.origin;
        let winsChart = null;
        let winRateChart = null;

        function createCardHTML(handValue) {
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const cards = [];
            let remaining = handValue;
            
            while (remaining > 0 && cards.length < 5) {
                const cardValue = Math.min(remaining, 10);
                remaining -= cardValue;
                const rank = ranks[Math.floor(Math.random() * 13)];
                const suit = suits[Math.floor(Math.random() * 4)];
                cards.push(`<div class="card-visual">${rank}${suit}</div>`);
            }
            
            return cards.join('');
        }

        async function updateLeaderboard() {
            try {
                const response = await fetch(`${BASE_URL}/api/leaderboard`);
                const agents = await response.json();
                
                const list = document.getElementById('leaderboard-list');
                if (agents && agents.length > 0) {
                    list.innerHTML = agents.map((agent, idx) => {
                        const total = agent.wins + agent.losses;
                        const ratio = total > 0 ? (agent.wins / total * 100).toFixed(1) : 0;
                        let medalEmoji = '';
                        if (idx === 0) medalEmoji = 'ü•á';
                        else if (idx === 1) medalEmoji = 'ü•à';
                        else if (idx === 2) medalEmoji = 'ü•â';
                        
                        return `
                            <div class="leaderboard-row">
                                <div><span class="rank">${medalEmoji} ${idx + 1}</span></div>
                                <div class="agent-name">${agent.name}</div>
                                <div class="stat-win">${agent.wins}</div>
                                <div class="stat-loss">${agent.losses}</div>
                                <div class="stat-bust">${agent.busts}</div>
                                <div style="color: #60a5fa;">${ratio}%</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="empty-state"><p>No agents yet</p></div>';
                }
            } catch (error) {
                console.error('Leaderboard error:', error);
            }
        }

        async function updateActionLog() {
            try {
                const response = await fetch(`${BASE_URL}/api/tables/main/log?limit=30`);
                const actions = await response.json();
                
                const logEl = document.getElementById('actionLog');
                if (actions && actions.length > 0) {
                    logEl.innerHTML = actions.map(action => {
                        const time = new Date(action.timestamp).toLocaleTimeString();
                        let resultBadge = '';
                        if (action.result) {
                            resultBadge = `<span class="result-${action.result}">${action.result.toUpperCase()}</span>`;
                        }
                        return `
                            <li class="action-item">
                                <div>
                                    <span class="agent-badge">${action.name}</span>
                                    <span class="action-type">${action.action_type.toUpperCase()}</span>
                                    <span class="hand-value">üí™ ${action.hand_value}</span>
                                    ${resultBadge}
                                </div>
                                <span class="time">üïê ${time}</span>
                            </li>
                        `;
                    }).join('');
                } else {
                    logEl.innerHTML = '<li class="empty-state"><p>No actions yet</p></li>';
                }
            } catch (error) {
                console.error('Log error:', error);
            }
        }

        async function updateCharts() {
            try {
                const response = await fetch(`${BASE_URL}/api/leaderboard`);
                const agents = await response.json();
                
                if (!agents || agents.length === 0) return;

                const top5 = agents.slice(0, 5);
                const winCtx = document.getElementById('winsChart');
                
                if (winsChart) winsChart.destroy();
                winsChart = new Chart(winCtx, {
                    type: 'bar',
                    data: {
                        labels: top5.map(a => a.name),
                        datasets: [{
                            label: 'Wins',
                            data: top5.map(a => a.wins),
                            backgroundColor: '#4ade80',
                            borderColor: '#22c55e',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                ticks: { color: '#888' },
                                grid: { color: 'rgba(74, 222, 128, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#888' },
                                grid: { display: false }
                            }
                        }
                    }
                });

                const winRateCtx = document.getElementById('winRateChart');
                const winRates = agents.map(a => {
                    const total = a.wins + a.losses;
                    return total > 0 ? (a.wins / total * 100) : 0;
                });

                if (winRateChart) winRateChart.destroy();
                winRateChart = new Chart(winRateCtx, {
                    type: 'doughnut',
                    data: {
                        labels: agents.map(a => a.name),
                        datasets: [{
                            data: winRates,
                            backgroundColor: ['#4ade80', '#60a5fa', '#f87171', '#fbbf24', '#8b5cf6', '#ec4899'],
                            borderColor: '#1a1a2e',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#888' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Charts error:', error);
            }
        }

        async function updateActiveGames() {
            try {
                const response = await fetch(`${BASE_URL}/api/leaderboard`);
                const agents = await response.json();
                
                const gamesList = document.getElementById('gamesList');
                if (agents && agents.length > 0) {
                    gamesList.innerHTML = agents.map(agent => {
                        const simHandValue = Math.floor(Math.random() * 21) + 5;
                        return `
                            <div class="game-card">
                                <h4>üéÆ ${agent.name}</h4>
                                <div class="hand-display">
                                    ${createCardHTML(simHandValue)}
                                </div>
                                <div class="hand-value-display">Hand Value: ${simHandValue}</div>
                                <div style="margin-top: 8px; font-size: 0.9em; color: #888;">
                                    Record: ${agent.wins}W - ${agent.losses}L
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    gamesList.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p>No active games</p></div>';
                }
            } catch (error) {
                console.error('Games error:', error);
            }
        }

        setInterval(() => {
            updateLeaderboard();
            updateActionLog();
            updateCharts();
            updateActiveGames();
        }, 2000);

        updateLeaderboard();
        updateActionLog();
        updateCharts();
        updateActiveGames();
    </script>
</body>
</html>
